<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Jikan Smart Hybrid Extractor v17</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { background: #0b0e14; color: #ecf0f1; font-family: 'Pretendard', sans-serif; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: #151f28; padding: 30px; border-radius: 15px; border: 1px solid #2e3c4a; }
        #log { background: #000; color: #00ffcc; height: 350px; overflow-y: auto; padding: 15px; font-family: monospace; font-size: 12px; border: 1px solid #2e3c4a; margin-bottom: 10px; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; background: #00d1b2; color: #000; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        .progress-bar { height: 8px; background: #2e3c4a; width: 100%; border-radius: 4px; margin: 10px 0; }
        #bar-fill { height: 100%; background: #00d1b2; width: 0%; transition: 0.3s; }
        textarea { width: 100%; height: 150px; background: #0b1622; color: #8ba3ad; border: 1px solid #2e3c4a; border-radius: 8px; padding: 10px; font-size: 11px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Smart Hybrid Extractor v17</h1>
        <p style="color:#8ba3ad; font-size: 14px;">ì„œë²„ ë¶€í•˜ ë°©ì§€: ë¡œì»¬ ì„ ë³„ í›„ ìµœì†Œ ìš”ì²­ (500 ì—ëŸ¬ íšŒí”¼)</p>
        <div class="controls">
            <button onclick="startExtraction()">ìŠ¤ë§ˆíŠ¸ ì¶”ì¶œ ì‹œì‘</button>
            <button style="background:#f1c40f;" onclick="downloadJS()">JS ì €ì¥</button>
            <button id="img-btn" style="background:#e74c3c; color:#fff;" onclick="downloadAllImages()" disabled>ì´ë¯¸ì§€ ZIP</button>
        </div>
        <div class="progress-bar"><div id="bar-fill"></div></div>
        <div id="log">ì¤€ë¹„ ì™„ë£Œ. [ìŠ¤ë§ˆíŠ¸ ì¶”ì¶œ ì‹œì‘]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        <textarea id="output" readonly placeholder="ê²°ê³¼ JSONì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤."></textarea>
    </div>

    <script>
        let rookieStore = {};
        let imageFiles = [];
        const THIS_YEAR = 2026; // í•„ìš”ì‹œ 2025ë¡œ ë³€ê²½ ê°€ëŠ¥

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
        function clean(str) { return str.replace(/[^ê°€-í£a-zA-Z0-9]/g, ''); }

        // ì¬ì‹œë„ ë¡œì§ì´ í¬í•¨ëœ Fetch í•¨ìˆ˜
        async function fetchSmart(url, retries = 3) {
            try {
                const res = await fetch(url);
                if (res.status === 429) { // ë„ˆë¬´ ë¹ ë¦„
                    await sleep(3000);
                    return fetchSmart(url, retries);
                }
                if (res.status === 500) { // ì„œë²„ ì—ëŸ¬
                    if (retries > 0) {
                        await sleep(5000); // 5ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„
                        console.warn(`Retry ${url} (${retries} left)`);
                        return fetchSmart(url, retries - 1);
                    } else {
                        throw new Error("Server Dead");
                    }
                }
                return await res.json();
            } catch (e) { return null; }
        }

        async function startExtraction() {
            const log = document.getElementById('log');
            const fill = document.getElementById('bar-fill');
            rookieStore = {}; imageFiles = [];
            
            // ë°ì´í„° ì„ì‹œ ì €ì¥ì†Œ (ID -> { info, works[] })
            let candidateMap = new Map();

            log.innerHTML = `ğŸ“¡ [1ë‹¨ê³„] ${THIS_YEAR}ë…„ ë°ì´í„° ìˆ˜ì§‘ ë° ë¡œì»¬ í•„í„°ë§...<br>`;
            const seasons = ['winter', 'spring', 'summer', 'fall'];

            for (let s of seasons) {
                const seasonData = await fetchSmart(`https://api.jikan.moe/v4/seasons/${THIS_YEAR}/${s}`);
                if (seasonData?.data) {
                    for (let anime of seasonData.data) {
                        // ìºë¦­í„° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                        const charData = await fetchSmart(`https://api.jikan.moe/v4/anime/${anime.mal_id}/characters`);
                        await sleep(800); // ê¸°ë³¸ ë”œë ˆì´

                        if (charData?.data) {
                            charData.data.forEach(c => {
                                c.voice_actors?.forEach(va => {
                                    if (va.language === 'Japanese') {
                                        const vaId = va.person.mal_id;
                                        
                                        // ì„±ìš° ì •ë³´ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
                                        if (!candidateMap.has(vaId)) {
                                            candidateMap.set(vaId, {
                                                id: vaId,
                                                name: va.person.name,
                                                roles: []
                                            });
                                        }

                                        // ë°°ì—­ ì •ë³´ ë¡œì»¬ ì €ì¥
                                        candidateMap.get(vaId).roles.push({
                                            animeTitle: anime.title,
                                            animeId: anime.mal_id,
                                            charName: c.character.name,
                                            charRole: c.role, // Main, Supporting, Background
                                            charImg: c.character.images?.jpg?.image_url
                                        });
                                    }
                                });
                            });
                        }
                    }
                }
                log.innerHTML += `âœ… ${s} ì‹œì¦Œ ë°ì´í„° ë©”ëª¨ë¦¬ ì ì¬ ì™„ë£Œ<br>`;
                log.scrollTop = log.scrollHeight;
            }

            // [2ë‹¨ê³„: ë¡œì»¬ í•„í„°ë§] - API ìš”ì²­ ì—†ì´ ë©”ëª¨ë¦¬ì—ì„œ íƒˆë½ì‹œí‚¤ê¸°
            const allCandidates = Array.from(candidateMap.values());
            log.innerHTML += `ğŸ” ì „ì²´ ${allCandidates.length}ëª… ì¤‘ ìê²© ë¯¸ë‹¬ì ì œê±° ì¤‘...<br>`;

            const survivors = allCandidates.filter(va => {
                // ì¡°ê±´ 1: ì˜¬í•´ 2ì‘í’ˆ ì´ìƒ
                // ì¤‘ë³µ ì• ë‹ˆë©”ì´ì…˜ ì œê±° (1ì‘í’ˆ 2ë°°ì—­ì€ 1ì‘í’ˆìœ¼ë¡œ ì¹  ê²ƒì¸ê°€? -> ë³´í†µ ì‘í’ˆìˆ˜ ê¸°ì¤€)
                const uniqueWorks = new Set(va.roles.map(r => r.animeId));
                if (uniqueWorks.size < 2) return false;

                // ì¡°ê±´ 2: ì£¼ì—°(Main) ë˜ëŠ” ì¡°ì—°(Supporting)ì´ í•˜ë‚˜ë¼ë„ ìˆëŠ”ê°€?
                const hasImportantRole = va.roles.some(r => r.charRole === 'Main' || r.charRole === 'Supporting');
                if (!hasImportantRole) return false;

                return true;
            });

            log.innerHTML += `ğŸ“‰ í•„í„°ë§ ê²°ê³¼: ${allCandidates.length}ëª… â” <span style="color:#f1c40f; font-weight:bold;">${survivors.length}ëª…</span>ìœ¼ë¡œ ì••ì¶•ë¨.<br>`;
            log.innerHTML += `ğŸš€ [3ë‹¨ê³„] ìµœì¢… ìƒì¡´ì ${survivors.length}ëª… ë°ë·” ì—°ë„ ê²€ì¦ ì‹œì‘...<br>`;

            // [3ë‹¨ê³„: ìƒì¡´ìë§Œ ì •ë°€ ê²€ì‚¬]
            for (let i = 0; i < survivors.length; i++) {
                fill.style.width = `${((i + 1) / survivors.length) * 100}%`;
                await verifyRookie(survivors[i], log);
                await sleep(1500); // 500 ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•œ ì¶©ë¶„í•œ íœ´ì‹
            }

            log.innerHTML += "âœ¨ ëª¨ë“  ì‘ì—… ì™„ë£Œ!";
            document.getElementById('img-btn').disabled = false;
            updateOutput();
        }

        async function verifyRookie(va, log) {
            // voices API í˜¸ì¶œ (ë°ë·”ì¼ í™•ì¸ìš©)
            // ì—¬ê¸°ê°€ 500 ì—ëŸ¬ê°€ ë‚˜ëŠ” ê³³ì´ë¯€ë¡œ, ì‹¤íŒ¨ ì‹œì—ë„ ë¡œì»¬ ë°ì´í„°ë¡œ ì‚´ë¦´ì§€ ê²°ì •í•´ì•¼ í•¨
            const voiceData = await fetchSmart(`https://api.jikan.moe/v4/people/${va.id}/voices`);
            
            let debutYear = THIS_YEAR;
            let totalWorks = 0;

            if (voiceData && voiceData.data) {
                const uniqueAllWorks = new Set(voiceData.data.map(v => v.anime.mal_id));
                totalWorks = uniqueAllWorks.size;
                
                // ê°€ì¥ ì˜¤ë˜ëœ ID ì°¾ê¸° (IDê°€ ì‘ì„ìˆ˜ë¡ ì˜¤ë˜ëœ ì‘í’ˆ)
                // ì •í™•í•œ ì—°ë„ ì¡°íšŒë¥¼ ìœ„í•´ ìµœì†Œê°’ ID ì‘í’ˆ í•˜ë‚˜ë§Œ ì¡°íšŒ
                const minId = Math.min(...uniqueAllWorks);
                const firstAnime = await fetchSmart(`https://api.jikan.moe/v4/anime/${minId}`);
                debutYear = firstAnime?.data?.aired?.prop?.from?.year || THIS_YEAR;
                await sleep(500);
            } else {
                log.innerHTML += `<span style="color:orange;">âš ï¸ ${va.name}: ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨(500). 2026ë…„ ë°ì´í„°ë¡œë§Œ íŒë‹¨í•©ë‹ˆë‹¤.</span><br>`;
                // API ì‹¤íŒ¨ ì‹œ, ì˜¬í•´ ë°ì´í„°ê°€ í™•ì‹¤í•˜ë¯€ë¡œ ì¼ë‹¨ ë£¨í‚¤ í›„ë³´ë¡œ ë‘¡ë‹ˆë‹¤ (ìˆ˜ë™ ê²€ì¦ í•„ìš” í‘œì‹œ)
                debutYear = THIS_YEAR; 
                totalWorks = 20; // ê°€ìƒì˜ ì•ˆì „ê°’
            }

            const yearsActive = THIS_YEAR - debutYear;
            let isRookie = false;

            // ì¡°ê±´ íŒë‹¨
            if (yearsActive <= 5 && totalWorks <= 30) isRookie = true;
            else if (yearsActive > 5 && va.roles.length <= 5 && totalWorks <= 20) isRookie = true;

            if (isRookie) {
                log.innerHTML += `<span style="color:#00d1b2;">[RISING]</span> ${va.name} (ë°ë·”:${debutYear}/ì˜¬í•´:${va.roles.length}ì‘)<br>`;
                log.scrollTop = log.scrollHeight;

                rookieStore[va.name] = {
                    name: va.name,
                    characters: va.roles.map(r => {
                        const fileName = `${clean(va.name)}${clean(r.charName)}.jpg`;
                        if(r.charImg) imageFiles.push({ url: r.charImg, name: fileName });
                        return {
                            animetitle: r.animeTitle,
                            charName: r.charName,
                            charRole: r.charRole,
                            charimg: `../image/rookiecv/${fileName}`
                        };
                    })
                };
            }
        }

        function updateOutput() { document.getElementById('output').value = "const RookieCVData = " + JSON.stringify(rookieStore, null, 2) + ";"; }
        function downloadJS() { saveAs(new Blob([document.getElementById('output').value], {type:'text/javascript'}), 'RookieCV.js'); }
        async function downloadAllImages() {
            const zip = new JSZip();
            for (let img of imageFiles) {
                try {
                    const res = await fetch(img.url);
                    const blob = await res.blob();
                    zip.file(img.name, blob);
                } catch (e) {}
            }
            zip.generateAsync({type:"blob"}).then(c => saveAs(c, "smart_rookie_images.zip"));
        }
    </script>
</body>
</html>