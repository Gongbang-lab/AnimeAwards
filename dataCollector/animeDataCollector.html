<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì• ë‹ˆë©”ì´ì…˜ ìˆ˜ì§‘ê¸° (ì¡°ê±´ë¶€ ì¶”ì¶œ ë²„ì „)</title>
  <style>
    body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #f5f7fa; color: #333; }
    .container { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
    .section { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    h3 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .search-input { width: calc(100% - 24px); padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
    .btn-search { width: 100%; background: #4a5568; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
    .search-item { display: flex; gap: 12px; padding: 10px; border-bottom: 1px solid #edf2f7; cursor: pointer; align-items: center; }
    .search-item img { width: 45px; height: 63px; border-radius: 4px; object-fit: cover; }
    .preview-header { display: flex; gap: 20px; margin-bottom: 20px; }
    .preview-header img { width: 140px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    #codeOutput { width: 100%; height: 320px; font-family: 'Fira Code', monospace; background: #1a202c; color: #e2e8f0; padding: 15px; border-radius: 8px; border: none; box-sizing: border-box; line-height: 1.5; overflow-y: auto; }
    .btn-copy { width: 100%; background: #38a169; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    .staff-preview { font-size: 12px; color: #4a5568; margin-top: 10px; background: #f8fafc; padding: 10px; border-radius: 6px; }
  </style>
</head>
<body>

<div class="container">
  <div class="section">
    <h3>ğŸ” ì• ë‹ˆë©”ì´ì…˜ ê²€ìƒ‰</h3>
    <input type="text" id="query" class="search-input" placeholder="ì œëª© ë˜ëŠ” MAL ID ì…ë ¥" onkeypress="if(event.keyCode==13) searchAnime()">
    <button class="btn-search" onclick="searchAnime()">ì¡°ì‚¬í•˜ê¸°</button>
    <div id="status" style="font-size: 13px; color: #3182ce; margin-bottom: 10px;"></div>
    <div id="searchResult"></div>
  </div>

  <div class="section">
    <h3>ğŸ“„ ì¶”ì¶œ ë°ì´í„° (ì¡°ê±´ë¶€ ìŠ¤íƒœí”„)</h3>
    <div id="preview" style="display:none;">
      <div class="preview-header">
        <img id="p-img" src="">
        <div class="info">
          <h4 id="p-title" style="margin:0 0 5px 0;"></h4>
          <p id="p-title-jp" style="font-size:13px; color:#718096; margin:0 0 10px 0;"></p>
          <div style="font-size: 13px; line-height: 1.6;">
            <b>ID:</b> <span id="p-id"></span> | <b>ìš”ì¼:</b> <span id="p-day"></span><br>
            <b>í™”ìˆ˜:</b> <span id="p-eps"></span>í™” | <b>ì œì‘ì‚¬:</b> <span id="p-studio"></span>
          </div>
          <div id="p-staff" class="staff-preview"></div>
        </div>
      </div>
      <textarea id="codeOutput" readonly></textarea>
      <button class="btn-copy" onclick="copyCode()">ì½”ë“œ ë³µì‚¬í•˜ê¸°</button>
    </div>
  </div>
</div>

<script>
  async function searchAnime() {
    const query = document.getElementById('query').value.trim();
    if(!query) return;
    if (/^\d+$/.test(query)) { getAnimeDetail(query); return; }
    
    const status = document.getElementById('status');
    status.innerText = "ğŸ” ì œëª© ê²€ìƒ‰ ì¤‘...";
    try {
      const resp = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(query)}&limit=8`);
      const json = await resp.json();
      document.getElementById('searchResult').innerHTML = json.data.map(anime => `
        <div class="search-item" onclick="getAnimeDetail(${anime.mal_id})">
          <img src="${anime.images.jpg.image_url}">
          <div>
            <div style="font-weight:bold; font-size:14px;">${anime.title}</div>
            <div style="font-size:12px; color:#718096;">${anime.title_japanese || ''}</div>
          </div>
        </div>
      `).join('');
      status.innerText = `âœ… ê²€ìƒ‰ ì™„ë£Œ`;
    } catch (e) { status.innerText = "âŒ ê²€ìƒ‰ ì—ëŸ¬"; }
  }

  async function getAnimeDetail(id) {
    const status = document.getElementById('status');
    status.innerText = `â³ ID ${id} ì •ë³´ ì¶”ì¶œ ì¤‘...`;
    
    try {
      const [animeResp, staffResp] = await Promise.all([
        fetch(`https://api.jikan.moe/v4/anime/${id}`),
        fetch(`https://api.jikan.moe/v4/anime/${id}/staff`)
      ]);

      const animeJson = await animeResp.json();
      const staffJson = await staffResp.json();
      const data = animeJson.data;
      const staffData = staffJson.data;

      // ì›ì‘ ì†ŒìŠ¤ í™•ì¸ (Manga, Light Novel ë“± vs Original)
      const isOriginal = data.source === "Original";

      const staffObj = {
        director: [],
        character_design: []
      };

      // ì¡°ê±´ì— ë”°ë¼ í•„ë“œ ì´ë¦„ ê²°ì •
      const writerField = isOriginal ? "scriptwriter" : "adaptor";
      staffObj[writerField] = [];

      staffData.forEach(person => {
        const positions = person.positions.map(p => p.toLowerCase());
        const name = person.person.name;

        // ë©”ì¸ ê°ë…
        if (positions.some(p => (p === 'director' || p === 'series director') && !p.includes('animation') && !p.includes('sound') && !p.includes('episode'))) {
          staffObj.director.push(name);
        }

        // ìºë¦­í„° ë””ìì¸
        if (positions.some(p => p.includes('character design'))) {
          staffObj.character_design.push(name);
        }

        // ê°ë³¸/ê°ìƒ‰ í•„í„°ë§
        if (isOriginal) {
          // ì˜¤ë¦¬ì§€ë„ì¼ ë•Œ: Script ë‹´ë‹¹ìë§Œ ì¶”ì¶œ
          if (positions.some(p => p === 'script')) staffObj[writerField].push(name);
        } else {
          // ì›ì‘ì´ ìˆì„ ë•Œ: Series Composition(ê°ìƒ‰ê°€) ë‹´ë‹¹ìë§Œ ì¶”ì¶œ
          if (positions.some(p => p.includes('series composition'))) staffObj[writerField].push(name);
        }
      });

      const animeObj = {
        id: data.mal_id,
        title: data.title, 
        thumbnail: data.images.jpg.large_image_url,
        day: data.broadcast.day || "Unknown",
        episodes: data.episodes || 0,
        studio: data.studios.length > 0 ? data.studios[0].name : "Unknown",
        staff: staffObj
      };

      document.getElementById('preview').style.display = "block";
      document.getElementById('p-img').src = animeObj.thumbnail;
      document.getElementById('p-title').innerText = animeObj.title;
      document.getElementById('p-title-jp').innerText = data.title_japanese || '';
      document.getElementById('p-id').innerText = animeObj.id;
      document.getElementById('p-day').innerText = animeObj.day;
      document.getElementById('p-eps').innerText = animeObj.episodes;
      document.getElementById('p-studio').innerText = animeObj.studio;
      
      document.getElementById('p-staff').innerHTML = `
        <b>ë©”ì¸ ê°ë…:</b> ${staffObj.director.join(', ') || 'N/A'}<br>
        <b>${isOriginal ? 'ê°ë³¸ê°€(ì˜¤ë¦¬ì§€ë„)' : 'ê°ìƒ‰ê°€(ì‹œë¦¬ì¦ˆ êµ¬ì„±)'}:</b> ${staffObj[writerField].join(', ') || 'N/A'}<br>
        <b>ìºë¦­í„° ë””ìì¸:</b> ${staffObj.character_design.join(', ') || 'N/A'}
      `;

      document.getElementById('codeOutput').value = JSON.stringify(animeObj, null, 2) + ",";
      status.innerText = `âœ… "${animeObj.title}" ì¶”ì¶œ ì™„ë£Œ (${isOriginal ? 'ì˜¤ë¦¬ì§€ë„' : 'ì›ì‘ê¸°ë°˜'})`;
    } catch (e) { status.innerText = "âŒ ìƒì„¸ ì •ë³´ ì—ëŸ¬"; }
  }

  function copyCode() {
    const area = document.getElementById('codeOutput');
    area.select();
    document.execCommand('copy');
    alert("ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
  }
</script>
</body>
</html>