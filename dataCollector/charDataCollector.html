<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìºë¦­í„° ë°ì´í„° & ì´ë¯¸ì§€ ìˆ˜ì§‘ê¸°</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  
  <style>
    body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #f8f9fa; color: #333; }
    .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .header-box { border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; }
    .char-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f1f1f1; gap: 15px; }
    .char-item:hover { background: #fafafa; }
    .char-item img { width: 50px; height: 70px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
    
    .info-box { flex: 1; display: flex; flex-direction: column; gap: 3px; }
    .name-jp { font-size: 14px; font-weight: bold; color: #2d3748; }
    .name-en-sub { font-size: 11px; color: #94a3b8; }
    .va-info { font-size: 11px; color: #64748b; }
    
    .role-badge { width: 80px; text-align: center; font-size: 11px; font-weight: bold; padding: 3px 0; border-radius: 20px; text-transform: uppercase; }
    .Main { background: #fed7d7; color: #9b2c2c; }
    .Supporting { background: #edf2f7; color: #4a5568; }

    #resultArea { width: 100%; height: 250px; font-family: 'Consolas', monospace; background: #2d3748; color: #edf2f7; padding: 15px; border-radius: 8px; margin-top: 10px; box-sizing: border-box; }
    .controls { display: flex; gap: 10px; margin-bottom: 20px; }
    input[type="text"], select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
    
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    button { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; flex: 1; }
    
    .btn-fetch { background: #4a5568; color: white; flex: none; width: 150px; }
    .btn-gen { background: #38a169; color: white; }
    .btn-download { background: #e53e3e; color: white; }
    button:hover { opacity: 0.8; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    
    .char-check { width: 20px; height: 20px; cursor: pointer; }
  </style>
</head>
<body>

<div class="container">
  <div class="header-box">
    <h2>ğŸ‘¥ ìºë¦­í„° ìˆ˜ì§‘ê¸° (ì„±ë³„ í•„ë“œ ì¶”ê°€)</h2>
    <p style="font-size: 0.9em; color: #666;">
        <b>JSON:</b> ì¼ë³¸ì–´ ì´ë¦„ ë° ì„±ë³„ í•„ë“œ ìƒì„± | <b>ì´ë¯¸ì§€:</b> ì˜ì–´ ì´ë¦„ìœ¼ë¡œ ì €ì¥
    </p>
  </div>
  
  <div class="controls">
    <input type="text" id="animeId" placeholder="MAL ID (ì˜ˆ: 52991)">
    <select id="quarter">
        <option value="Q1">1ë¶„ê¸° (Q1)</option>
        <option value="Q2">2ë¶„ê¸° (Q2)</option>
        <option value="Q3">3ë¶„ê¸° (Q3)</option>
        <option value="Q4">4ë¶„ê¸° (Q4)</option>
    </select>
    <button class="btn-fetch" onclick="fetchCharacters()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
  </div>
  
  <div id="status" style="margin-bottom: 10px; font-weight: bold; color: #3182ce;"></div>

  <div id="charListContainer" style="max-height: 450px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;"></div>

  <div class="btn-group">
    <button class="btn-gen" onclick="generateCode()">JSON ìƒì„±</button>
    <button class="btn-download" id="downloadBtn" onclick="downloadImages()" disabled>ğŸ“ ì´ë¯¸ì§€ ZIP ë‹¤ìš´ë¡œë“œ</button>
  </div>
  
  <textarea id="resultArea" readonly placeholder="ê²°ê³¼ JSON ì½”ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
</div>

<script>
  let characterList = [];

  async function fetchCharacters() {
    const id = document.getElementById('animeId').value;
    const container = document.getElementById('charListContainer');
    const status = document.getElementById('status');
    const downloadBtn = document.getElementById('downloadBtn');
    
    if(!id) return alert("IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    status.innerText = "â³ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
    container.innerHTML = "";
    downloadBtn.disabled = true;

    try {
      const response = await fetch(`https://api.jikan.moe/v4/anime/${id}/characters`);
      const resJson = await response.json();
      
      characterList = resJson.data.filter(c => c.role === "Main" || c.role === "Supporting");

      container.innerHTML = characterList.map((item, index) => {
        const nameEN = item.character.name;
        const nameJP = item.character.name_kanji || nameEN;
        const vaJP = item.voice_actors.find(va => va.language === 'Japanese')?.person.name || 'N/A';
        
        return `
          <div class="char-item">
            <input type="checkbox" class="char-check" data-index="${index}" ${item.role === 'Main' ? 'checked' : ''}>
            <img src="${item.character.images.jpg.image_url}" crossorigin="anonymous">
            <div class="role-badge ${item.role}">${item.role}</div>
            <div class="info-box">
                <div class="name-jp">${nameJP}</div>
                <div class="name-en-sub">íŒŒì¼ëª… ì˜ˆì •: ${nameEN}.jpg</div>
                <div class="va-info">CV: ${vaJP}</div>
            </div>
          </div>
        `;
      }).join('');

      status.innerText = `âœ… ${characterList.length}ëª…ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`;
      downloadBtn.disabled = false;
    } catch (e) {
      status.innerText = "âŒ ì—ëŸ¬: " + e.message;
    }
  }

  function generateCode() {
    const animeId = document.getElementById('animeId').value;
    const quarter = document.getElementById('quarter').value;
    const checks = document.querySelectorAll('.char-check:checked');
    const finalData = [];

    checks.forEach(check => {
      const index = check.getAttribute('data-index');
      const originalData = characterList[index];

      const nameEN = originalData.character.name;
      const nameJP = originalData.character.name_kanji || nameEN;
      const vaJP = originalData.voice_actors.find(va => va.language === "Japanese")?.person.name || "Unknown";

      const safeFileName = nameEN.replace(/[<>:"/\\|?*]/g, "").trim();

      finalData.push({
        id: originalData.character.mal_id,
        name: nameJP,
        gender: "", // ì„±ë³„ í•„ë“œ ë¹ˆê°’ ì¶”ê°€
        vc: vaJP,
        img: `../image/charimg/${quarter}/${safeFileName}.jpg`
      });
    });

    const resultArea = document.getElementById('resultArea');
    const output = { [animeId]: finalData };
    resultArea.value = JSON.stringify(output, null, 2) + ",";
    resultArea.select();
  }

  async function downloadImages() {
    const checks = document.querySelectorAll('.char-check:checked');
    const status = document.getElementById('status');
    const zip = new JSZip();
    const folder = zip.folder("characters");
    let count = 0;

    if (checks.length === 0) return alert("ì„ íƒëœ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    status.innerText = "â³ ì´ë¯¸ì§€ ìˆ˜ì§‘ ë° ì••ì¶• ì¤‘...";

    for (const check of checks) {
        const index = check.getAttribute('data-index');
        const nameEN = characterList[index].character.name;
        const safeFileName = nameEN.replace(/[<>:"/\\|?*]/g, "").trim();
        const imgUrl = characterList[index].character.images.jpg.image_url;

        try {
            const imgRes = await fetch(imgUrl);
            const blob = await imgRes.blob();
            folder.file(`${safeFileName}.jpg`, blob);
            count++;
        } catch (err) {
            console.error("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:", nameEN, err);
        }
    }

    zip.generateAsync({type:"blob"}).then(function(content) {
        saveAs(content, `anime_${document.getElementById('animeId').value}_images.zip`);
        status.innerText = `âœ… ${count}ê°œì˜ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!`;
    });
  }
</script>

</body>
</html>