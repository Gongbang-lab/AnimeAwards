<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>캐릭터 수집기 (직접 수정 모드)</title>
  <style>
    body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #f8f9fa; color: #333; }
    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .header-box { border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; }
    .char-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f1f1f1; gap: 15px; }
    .char-item:hover { background: #fafafa; }
    .char-item img { width: 50px; height: 70px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
    
    /* 입력창 스타일 */
    .edit-name { flex: 1; padding: 8px 12px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 14px; font-weight: 600; }
    .edit-name:focus { border-color: #3182ce; outline: none; background: #ebf8ff; }
    
    .role-badge { width: 80px; text-align: center; font-size: 11px; font-weight: bold; padding: 3px 0; border-radius: 20px; text-transform: uppercase; }
    .Main { background: #fed7d7; color: #9b2c2c; }
    .Supporting { background: #edf2f7; color: #4a5568; }

    #resultArea { width: 100%; height: 250px; font-family: 'Consolas', monospace; background: #2d3748; color: #edf2f7; padding: 15px; border-radius: 8px; margin-top: 20px; }
    .controls { display: flex; gap: 10px; margin-bottom: 20px; }
    input[type="text"] { padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
    button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
    .btn-fetch { background: #4a5568; color: white; }
    .btn-gen { background: #38a169; color: white; width: 100%; margin-top: 10px; font-size: 16px; }
    button:hover { opacity: 0.8; }
  </style>
</head>
<body>

<div class="container">
  <div class="header-box">
    <h2>✍️ 캐릭터 데이터 빌더</h2>
    <p style="font-size: 0.9em; color: #666;">ID 입력 후 캐릭터를 불러오세요. <b>이름 칸을 직접 클릭해 한글로 수정</b>할 수 있습니다.</p>
  </div>
  
  <div class="controls">
    <input type="text" id="animeId" placeholder="MAL ID (예: 52991)">
    <button class="btn-fetch" onclick="fetchCharacters()">데이터 불러오기</button>
  </div>
  
  <div id="status" style="margin-bottom: 10px; font-weight: bold; color: #3182ce;"></div>

  <div id="charListContainer" style="max-height: 500px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
    </div>

  <button class="btn-gen" onclick="generateCode()">최종 JSON 코드 생성하기</button>
  <textarea id="resultArea" readonly placeholder="여기에 결과 코드가 생성됩니다."></textarea>
</div>

<script>
  let characterList = [];

  async function fetchCharacters() {
    const id = document.getElementById('animeId').value;
    const container = document.getElementById('charListContainer');
    const status = document.getElementById('status');
    
    if(!id) return alert("ID를 입력해주세요.");
    status.innerText = "⏳ 데이터를 가져오는 중...";
    container.innerHTML = "";

    try {
      const response = await fetch(`https://api.jikan.moe/v4/anime/${id}/characters`);
      const resJson = await response.json();
      
      characterList = resJson.data.filter(c => c.role === "Main" || c.role === "Supporting");

      container.innerHTML = characterList.map((item, index) => {
        const engName = item.character.name;
        const jpnName = item.character.name_kanji || "";
        // 기본 포맷: 영문명(일본명)
        const defaultValue = `${engName}${jpnName ? '(' + jpnName + ')' : ''}`;
        
        return `
          <div class="char-item" data-index="${index}">
            <input type="checkbox" class="char-check" value="${item.character.mal_id}" ${item.role === 'Main' ? 'checked' : ''}>
            <img src="${item.character.images.jpg.image_url}">
            <div class="role-badge ${item.role}">${item.role}</div>
            <input type="text" class="edit-name" value="${defaultValue}" id="input-${index}">
            <div style="font-size: 12px; color: #999; width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              CV: ${item.voice_actors.find(va => va.language === 'Japanese')?.person.name || 'N/A'}
            </div>
          </div>
        `;
      }).join('');

      status.innerText = `✅ ${characterList.length}명의 데이터를 불러왔습니다. 이름을 수정하신 후 하단 버튼을 누르세요.`;
    } catch (e) {
      status.innerText = "❌ 에러: " + e.message;
    }
  }

  function generateCode() {
    const animeId = document.getElementById('animeId').value;
    const charItems = document.querySelectorAll('.char-item');
    const finalData = [];

    charItems.forEach(item => {
      const isChecked = item.querySelector('.char-check').checked;
      if (isChecked) {
        const index = item.getAttribute('data-index');
        const updatedName = document.getElementById(`input-${index}`).value;
        const originalData = characterList[index];

        finalData.push({
          id: originalData.character.mal_id,
          name: updatedName,
          cv: originalData.voice_actors.find(va => va.language === "Japanese")?.person.name || "Unknown",
          img: `${originalData.character.mal_id}.jpg`
        });
      }
    });

    const resultArea = document.getElementById('resultArea');
    resultArea.value = `"${animeId}": ${JSON.stringify(finalData, null, 2)},`;
    resultArea.select();
  }
</script>

</body>
</html>