<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Ï†ÑÏ≤¥ Ï∫êÎ¶≠ÌÑ∞ Ï∂îÏ∂úÍ∏∞ (Main & Supporting)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    /* Í∏∞Ï°¥ Ïä§ÌÉÄÏùº Ïú†ÏßÄ Î∞è Í∞ÄÎèÖÏÑ± Í∞úÏÑ† */
    body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #f8f9fa; }
    .header { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 5px solid #2563eb; }
    .search-area { position: relative; max-width: 600px; display: flex; gap: 10px; }
    #searchInput { flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; outline: none; }
    .results-dropdown { position: absolute; top: 55px; width: 100%; background: white; border: 1px solid #ddd; border-radius: 8px; z-index: 100; display: none; max-height: 250px; overflow-y: auto; }
    .res-item { display: flex; gap: 12px; padding: 10px; cursor: pointer; border-bottom: 1px solid #f1f5f9; align-items: center; }
    .res-item:hover { background: #f0f7ff; }
    .res-item img { width: 40px; height: 55px; object-fit: cover; border-radius: 4px; }

    .main { display: grid; grid-template-columns: 1.2fr 1fr; gap: 20px; }
    .char-list { background: white; padding: 20px; border-radius: 12px; height: 750px; overflow-y: auto; border: 1px solid #e2e8f0; }
    .char-card { display: flex; gap: 15px; background: #fff; border: 1px solid #f1f5f9; padding: 15px; border-radius: 10px; margin-bottom: 12px; }
    .char-card img { width: 80px; height: 110px; object-fit: cover; border-radius: 6px; background: #f8f9fa; }
    .role-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-bottom: 5px; }
    .role-main { background: #fee2e2; color: #ef4444; }
    .role-supporting { background: #dcfce7; color: #22c55e; }

    .edit-fields { flex: 1; display: flex; flex-direction: column; gap: 5px; }
    .edit-fields input { padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px; }
    
    #jsonPreview { width: 100%; height: 600px; background: #0f172a; color: #f1f5f9; padding: 15px; border-radius: 12px; font-family: 'Fira Code', monospace; font-size: 12px; box-sizing: border-box; }
    .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
    .btn-zip { background: #ea580c; color: white; }
    .btn-copy { background: #16a34a; color: white; }
  </style>
</head>
<body>

<div class="header">
  <h2>üë• Ï∫êÎ¶≠ÌÑ∞ Ï∂îÏ∂úÍ∏∞ (Main + Supporting)</h2>
  <div class="search-area">
    <input type="text" id="searchInput" placeholder="Ïï†ÎãàÎ©îÏù¥ÏÖò Í≤ÄÏÉâ..." oninput="searchAnime(this.value)">
    <div id="resultsDropdown" class="results-dropdown"></div>
  </div>
  <div style="margin-top: 10px; font-size: 13px; color: #64748b;">
    MAL ID: <input type="number" id="manualId" style="width: 80px;" oninput="updateManualId(this.value)">
    <span id="status" style="margin-left: 15px; font-weight: bold; color: #2563eb;"></span>
  </div>
</div>

<div class="main">
  <div class="char-list" id="charList"></div>
  <div class="side-panel">
    <textarea id="jsonPreview" readonly placeholder="JSON Í≤∞Í≥º..."></textarea>
    <button class="btn btn-copy" onclick="copyJSON()">JSON Î≥µÏÇ¨</button>
    <button id="zipBtn" class="btn btn-zip" onclick="downloadImagesZip()" disabled>üì¶ Ï†ÑÏ≤¥ Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú (.ZIP)</button>
  </div>
</div>

<script>
  const API_URL = 'https://graphql.anilist.co';
  let animeData = null;
  let characterItems = [];
  let currentMalId = null;

  async function searchAnime(query) {
    if (query.length < 2) { document.getElementById('resultsDropdown').style.display = 'none'; return; }
    const q = `query($s:String){Page(perPage:5){media(search:$s,type:ANIME){id idMal title{romaji native}coverImage{medium}}}}`;
    const res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query: q, variables: { s: query } }) });
    const json = await res.json();
    renderSearch(json.data.Page.media);
  }

  function renderSearch(list) {
    const d = document.getElementById('resultsDropdown');
    d.innerHTML = list.map(a => `<div class="res-item" onclick="selectAnime(${a.id})"><img src="${a.coverImage.medium}"><div><b>${a.title.romaji}</b></div></div>`).join('');
    d.style.display = 'block';
  }

  async function selectAnime(id) {
    document.getElementById('resultsDropdown').style.display = 'none';
    document.getElementById('status').innerText = "‚è≥ Ï†ÑÏ≤¥ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...";
    
    // perPageÎ•º 50ÏúºÎ°ú ÎäòÎ†§ ÎåÄÎã§ÏàòÏùò Ï£º/Ï°∞Ïó∞ÏùÑ Ìïú Î≤àÏóê Í∞ÄÏ†∏Ïò¥
    const q = `query($id:Int){Media(id:$id){id idMal title{romaji}characters(sort:[ROLE,RELEVANCE],perPage:50){edges{role node{id name{full native}gender image{large}}voiceActors(language:JAPANESE){name{full}}}}}}`;
    const res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query: q, variables: { id } }) });
    const json = await res.json();
    animeData = json.data.Media;
    currentMalId = animeData.idMal || "";
    document.getElementById('manualId').value = currentMalId;

    // BACKGROUND Ï†úÏô∏ ÌïÑÌÑ∞ÎßÅ
    characterItems = animeData.characters.edges
      .filter(edge => edge.role !== "BACKGROUND") 
      .map(edge => ({
        role: edge.role,
        engName: edge.node.name.full,
        korName: edge.node.name.native || edge.node.name.full,
        gender: edge.node.gender ? edge.node.gender.toLowerCase() : "unknown",
        vc: edge.voiceActors[0]?.name.full || "Unknown",
        imgUrl: edge.node.image.large
      }));

    renderChars();
    updateJSON();
    document.getElementById('zipBtn').disabled = false;
    document.getElementById('status').innerText = `‚úÖ ${characterItems.length}Î™Ö Î°úÎìúÎê® (Background Ï†úÏô∏)`;
  }

  function renderChars() {
    document.getElementById('charList').innerHTML = characterItems.map((c, i) => `
      <div class="char-card">
        <img src="${c.imgUrl}" alt="${c.engName}">
        <div class="edit-fields">
          <span class="role-badge ${c.role === 'MAIN' ? 'role-main' : 'role-supporting'}">${c.role}</span>
          <input type="text" value="${c.korName}" oninput="updateChar(${i}, 'korName', this.value)" placeholder="ÌïúÍ∏Ä Ïù¥Î¶Ñ">
          <input type="text" value="${c.vc}" oninput="updateChar(${i}, 'vc', this.value)" placeholder="ÏÑ±Ïö∞ Ïù¥Î¶Ñ">
          <select onchange="updateChar(${i}, 'gender', this.value)" style="padding:6px; border-radius:4px; border:1px solid #e2e8f0;">
            <option value="male" ${c.gender==='male'?'selected':''}>Male</option>
            <option value="female" ${c.gender==='female'?'selected':''}>Female</option>
            <option value="unknown" ${c.gender==='unknown'?'selected':''}>Unknown</option>
          </select>
        </div>
      </div>`).join('');
  }

  function updateChar(i, key, val) { characterItems[i][key] = val; updateJSON(); }
  function updateManualId(val) { currentMalId = val; updateJSON(); }

  function updateJSON() {
    const out = {
      id: parseInt(currentMalId) || currentMalId,
      title: animeData.title.romaji,
      characters: characterItems.map(c => ({
        name: c.korName,
        role: c.role,
        gender: c.gender,
        vc: c.vc,
        img: `../image/charimg/${animeData.title.romaji.replace(/\s+/g, '_')}/${c.engName.replace(/\s+/g, '_')}.jpg`
      }))
    };
    document.getElementById('jsonPreview').value = JSON.stringify(out, null, 2);
  }

  async function downloadImagesZip() {
    const zip = new JSZip();
    const folder = animeData.title.romaji.replace(/\s+/g, '_');
    document.getElementById('status').innerText = "üöÄ Ïù¥ÎØ∏ÏßÄ ÏßÅÏ†ë Îã§Ïö¥Î°úÎìú Ï§ë...";
    
    // Î≥ëÎ†¨ Îã§Ïö¥Î°úÎìú
    await Promise.all(characterItems.map(async (c) => {
      try {
        const imgRes = await fetch(c.imgUrl);
        const blob = await imgRes.blob();
        zip.file(`${folder}/${c.engName.replace(/\s+/g, '_')}.jpg`, blob);
      } catch (err) { console.error(err); }
    }));

    const content = await zip.generateAsync({type:"blob"});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(content);
    link.download = `${folder}_images.zip`;
    link.click();
    document.getElementById('status').innerText = "‚úÖ Îã§Ïö¥Î°úÎìú ÏôÑÎ£å!";
  }

  function copyJSON() {
    const t = document.getElementById('jsonPreview'); t.select(); document.execCommand('copy'); alert("JSON Î≥µÏÇ¨Îê®!");
  }
</script>
</body>
</html>