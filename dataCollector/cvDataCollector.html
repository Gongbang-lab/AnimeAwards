<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Voice Actor Data Extractor</title>
    <style>
        body { background: #111; color: #fff; font-family: 'Pretendard', sans-serif; text-align: center; padding-top: 50px; }
        .box { background: #222; display: inline-block; padding: 40px; border-radius: 20px; border: 1px solid #333; }
        button { padding: 18px 36px; font-size: 16px; cursor: pointer; background: gold; border: none; border-radius: 8px; font-weight: bold; color: #000; }
        button:hover { background: #ffd700; transform: scale(1.02); }
        #status { margin-top: 20px; color: gold; font-weight: bold; white-space: pre-line; }
        .error-msg { color: #ff4d4d !important; font-size: 14px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="box">
        <h1>성우 데이터 추출기</h1>
        <p style="color: #aaa;">AnimeByQuarter 데이터를 참조하여 애니메이션 한글 제목을 매칭합니다.</p>
        
        <button id="extract-btn">animeCharacterVoice.js 생성 및 다운로드</button>
        <div id="status"></div>
    </div>

    <script src="../data/animeData.js"></script>
    <script src="../data/animeCharacter.js"></script>

    <script>
document.getElementById('extract-btn').onclick = function() {
    const statusDiv = document.getElementById('status');
    
    try {
        if (typeof AnimeByQuarter === 'undefined' || typeof CharacterData === 'undefined') {
            throw new Error("데이터 파일을 로드할 수 없습니다. 경로를 확인하세요.");
        }

        // 1. animeData(AnimeByQuarter)의 모든 데이터를 ID를 Key로 하는 맵으로 변환 (검색 속도 향상)
        const animeTitleMap = {};
        Object.values(AnimeByQuarter).flat().forEach(anime => {
            animeTitleMap[String(anime.id)] = anime.title;
        });

        const actorMap = {};
        let processedCount = 0;

        // 2. CharacterData 순회 (Q1, Q2... 분기별로 순회)
        Object.values(CharacterData).forEach(quarterList => {
            quarterList.forEach(animeEntry => {
                const animeId = String(animeEntry.id);
                // animeData.js에서 한글 제목 가져오기, 없으면 animeCharacter.js의 영문 제목 사용
                const animeTitle = animeTitleMap[animeId] || animeEntry.title;
                const characters = animeEntry.characters || [];

                characters.forEach(char => {
                    const actorName = (char.cv || char.vc || "").trim();
                    if (!actorName || actorName === "정보 없음") return;

                    // 성우 객체 생성
                    if (!actorMap[actorName]) {
                        actorMap[actorName] = {
                            name: actorName,
                            cvimg: `../image/cvimg/${actorName}.webp`,
                            gender: char.gender || "male",
                            characters: []
                        };
                    }

                    // 중복 캐릭터 방지
                    const isDuplicate = actorMap[actorName].characters.some(
                        c => c.charName === char.name && c.animeTitle === animeTitle
                    );

                    if (!isDuplicate) {
                        actorMap[actorName].characters.push({
                            charName: char.name,
                            animeTitle: animeTitle,
                            img: char.img
                        });
                    }
                });
                processedCount++;
            });
        });

        // 3. 파일 생성 및 다운로드
        const finalContent = "const CharacterVoiceData = " + JSON.stringify(actorMap, null, 2) + ";";
        const blob = new Blob([finalContent], { type: 'text/javascript' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'animeCharacterVoice.js';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        statusDiv.className = "";
        statusDiv.innerText = `✅ 성공! ${processedCount}개의 작품을 분석했습니다.\n한글 제목 매칭이 완료된 파일이 다운로드됩니다.`;

    } catch (e) {
        console.error(e);
        statusDiv.className = "error-msg";
        statusDiv.innerText = "❌ 오류 발생: " + e.message;
    }
};
    </script>
</body>
</html>